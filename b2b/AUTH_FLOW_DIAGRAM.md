# Authentication Flow Diagram

## ğŸ” Login Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 1. Navigates to /login
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Login Page     â”‚
â”‚  (login.tsx)    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 2. Enters email & password
     â”‚ 3. Clicks "Sign In"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthContext        â”‚
â”‚  login() function   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 4. POST /auth/login
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend API        â”‚
â”‚  (NestJS)           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 5. Returns { access_token, partner }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthContext        â”‚
â”‚  - Store token      â”‚
â”‚  - Store user data  â”‚
â”‚  - Set cookies      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 6. router.push('/')
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Home Page          â”‚
â”‚  (Protected)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›¡ï¸ Protected Route Access

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Navigates to protected page
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProtectedRoute     â”‚
â”‚  Component          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€ isLoading? â”€â”€â”€â”€â”€â”€â”
     â”‚                         â”‚
     â”‚ No                    Yes
     â–¼                         â”‚
Is authenticated?              â”‚
     â”‚                         â”‚
     â”œâ”€â”€ Yes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚                 â”‚       â”‚
     â”‚ No              â”‚       â”‚
     â–¼                 â–¼       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirect to â”‚  â”‚ Render  â”‚  â”‚ Show     â”‚
â”‚ /login      â”‚  â”‚ Page    â”‚  â”‚ Spinner  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸŒ API Call Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Call useApi() or direct API
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Function     â”‚
â”‚ (lib/api.ts)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. getHeaders() - Adds token
       â”‚    from cookies
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fetch() request  â”‚
â”‚ + Authorization  â”‚
â”‚   Bearer <token> â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Send to backend
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend API      â”‚
â”‚ - Verify JWT     â”‚
â”‚ - Process req    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€ Success? â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                         â”‚
       â”‚ Yes                    No (401)
       â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ Return data      â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
       â”‚                        â”‚
       â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component        â”‚   â”‚ Auto logout()  â”‚
â”‚ receives data    â”‚   â”‚ â†’ Redirect to  â”‚
â”‚                  â”‚   â”‚   /login       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Session Persistence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User visits â”‚
â”‚ site        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Page loads
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthProvider        â”‚
â”‚ useEffect on mount  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Read cookies
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getCookie()         â”‚
â”‚ - auth-token        â”‚
â”‚ - auth-user         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€ Found? â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚
       â”‚ Yes               No
       â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ Parse user data â”‚        â”‚
â”‚ setPartner()    â”‚        â”‚
â”‚ User logged in  â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ User not logged â”‚
                  â”‚ in (null)       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸšª Logout Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks â”‚
â”‚ Logout btn  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ logout() function   â”‚
â”‚ in AuthContext      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. deleteCookie('auth-token')
       â”‚ 2. deleteCookie('auth-user')
       â”‚ 3. setPartner(null)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ router.push('/login')â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Login Page          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Component Hierarchy

```
App.tsx (AuthProvider)
â”‚
â”œâ”€â”€ Login Page (Public)
â”‚   â””â”€â”€ No layout
â”‚
â””â”€â”€ CommonLayout (Protected pages)
    â”œâ”€â”€ Header
    â”‚   â”œâ”€â”€ Logo
    â”‚   â”œâ”€â”€ Search
    â”‚   â”œâ”€â”€ Notifications
    â”‚   â””â”€â”€ User Dropdown
    â”‚       â”œâ”€â”€ Profile Info
    â”‚       â”œâ”€â”€ Branch Info
    â”‚       â””â”€â”€ Logout Button
    â”‚
    â”œâ”€â”€ Navigation
    â”‚
    â””â”€â”€ Page Content (ProtectedRoute)
        â”œâ”€â”€ Home
        â”œâ”€â”€ Agents
        â”œâ”€â”€ My Applications
        â”œâ”€â”€ Commission Hub
        â”œâ”€â”€ Contract Hub
        â”œâ”€â”€ Analytics
        â””â”€â”€ Support
```

## ğŸ¨ State Management

```
AuthContext State:
â”œâ”€â”€ partner: Partner | null
â”‚   â”œâ”€â”€ id: string
â”‚   â”œâ”€â”€ name: string
â”‚   â”œâ”€â”€ email: string
â”‚   â”œâ”€â”€ role: string
â”‚   â”œâ”€â”€ branch_id?: string
â”‚   â”œâ”€â”€ branch_name?: string
â”‚   â””â”€â”€ permissions?: string[]
â”‚
â”œâ”€â”€ isAuthenticated: boolean
â”‚   â””â”€â”€ !!partner
â”‚
â”œâ”€â”€ isLoading: boolean
â”‚   â””â”€â”€ true during initialization
â”‚
â”œâ”€â”€ login(email, password): Promise<void>
â”‚   â””â”€â”€ Authenticates and stores session
â”‚
â””â”€â”€ logout(): void
    â””â”€â”€ Clears session and redirects
```

## ğŸ”§ API Client Architecture

```
lib/api.ts
â”‚
â”œâ”€â”€ Helper Functions
â”‚   â”œâ”€â”€ getAuthToken()
â”‚   â”‚   â””â”€â”€ Reads token from cookies
â”‚   â”‚
â”‚   â”œâ”€â”€ getHeaders(includeAuth)
â”‚   â”‚   â””â”€â”€ Returns headers with optional token
â”‚   â”‚
â”‚   â””â”€â”€ handleResponse(res)
â”‚       â””â”€â”€ Parses response & handles errors
â”‚
â”œâ”€â”€ AuthAPI
â”‚   â””â”€â”€ login(email, password)
â”‚
â”œâ”€â”€ LeadsAPI
â”‚   â”œâ”€â”€ createLead()
â”‚   â”œâ”€â”€ getAll()
â”‚   â”œâ”€â”€ getById()
â”‚   â”œâ”€â”€ update()
â”‚   â””â”€â”€ delete()
â”‚
â”œâ”€â”€ AgentsAPI
â”‚   â”œâ”€â”€ onboard()
â”‚   â”œâ”€â”€ getAll()
â”‚   â”œâ”€â”€ getById()
â”‚   â”œâ”€â”€ updateStatus()
â”‚   â””â”€â”€ delete()
â”‚
â”œâ”€â”€ ApplicationsAPI
â”‚   â”œâ”€â”€ getByLeadId()
â”‚   â”œâ”€â”€ updatePersonal()
â”‚   â”œâ”€â”€ updateEducation()
â”‚   â”œâ”€â”€ updatePreferences()
â”‚   â”œâ”€â”€ updateTests()
â”‚   â”œâ”€â”€ updateWorkExperience()
â”‚   â”œâ”€â”€ updateVisa()
â”‚   â””â”€â”€ uploadDocuments()
â”‚
â”œâ”€â”€ DashboardAPI
â”‚   â””â”€â”€ getStats()
â”‚
â”œâ”€â”€ AnnouncementsAPI
â”‚   â”œâ”€â”€ getAll()
â”‚   â”œâ”€â”€ markAsRead()
â”‚   â””â”€â”€ getUnreadCount()
â”‚
â”œâ”€â”€ UniversitiesAPI
â”‚   â””â”€â”€ ... (existing)
â”‚
â””â”€â”€ CoursesAPI
    â””â”€â”€ ... (existing)
```

## ğŸ“± useApi Hook Flow

```
Component calls useApi(apiFunction)
â”‚
â”œâ”€â”€ Returns: { execute, loading, error, reset }
â”‚
â””â”€â”€ execute(...args)
    â”‚
    â”œâ”€â”€ setLoading(true)
    â”œâ”€â”€ setError(null)
    â”‚
    â”œâ”€â”€ try apiFunction(...args)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ Success
    â”‚   â”‚   â”œâ”€â”€ Call onSuccess()
    â”‚   â”‚   â””â”€â”€ Return data
    â”‚   â”‚
    â”‚   â””â”€â”€ Error
    â”‚       â”œâ”€â”€ Check if 401
    â”‚       â”‚   â””â”€â”€ Call logout()
    â”‚       â”‚
    â”‚       â”œâ”€â”€ setError(message)
    â”‚       â”œâ”€â”€ Call onError()
    â”‚       â””â”€â”€ Return null
    â”‚
    â””â”€â”€ setLoading(false)
```

## ğŸ¯ Token Lifecycle

```
Day 0: Login
  â†“
Cookie created (7-day expiration)
  â†“
Days 1-6: Normal usage
  â†“
  â”œâ”€â”€ Page refresh â†’ Token restored
  â”œâ”€â”€ API calls â†’ Token included
  â””â”€â”€ Navigation â†’ Token persists
  â†“
Day 7: Token expires
  â†“
API call returns 401
  â†“
Auto logout â†’ Redirect to login
```

## ğŸ”’ Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cookie Security                     â”‚
â”‚  - SameSite=Strict                  â”‚
â”‚  - Path=/                           â”‚
â”‚  - 7-day expiration                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client-Side Protection             â”‚
â”‚  - ProtectedRoute wrapper           â”‚
â”‚  - Auth state validation            â”‚
â”‚  - Automatic redirects              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer                          â”‚
â”‚  - Auto token injection             â”‚
â”‚  - 401 handling                     â”‚
â”‚  - Error boundaries                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend Verification               â”‚
â”‚  - JWT validation                   â”‚
â”‚  - Role verification                â”‚
â”‚  - Permission checks                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
